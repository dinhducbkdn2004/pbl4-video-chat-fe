name: Deploy React Vite to Azure VM

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            # Checkout code từ GitHub
            - name: Checkout code
              uses: actions/checkout@v3

            # Thiết lập SSH để kết nối với Azure VM
            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.5.3
              with:
                  ssh-private-key: ${{ secrets.AZURE_VM_PRIVATE_KEY }}

            
            - name: Deploy to Azure VM
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }} << EOF
                    cd ~/docker/pbl4-video-chat-fe

                    npm install --legacy-peer-deps
                    npm run build

                    scp -r dist/* ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }}:/var/www/pbl4-video-chat-fe/

            - name: Restart Nginx on Azure VM
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }} << EOF
                    sudo systemctl restart nginx
                  EOF
